#!/usr/bin/env bash

#!/bin/bash

# Check if an input file was provided
if [ "$#" -ne 1 ]; then
    echo "Usage: $0 <PDF file>"
    exit 1
fi

input_pdf="$1"
temp_dir=$(mktemp -d)
temp_output_dir=$(mktemp -d)

# Step 1: Convert PDF to images
echo "Converting PDF to images..."
pdftoppm "$input_pdf" "$temp_dir/output" -png

# Step 2: Use OCR to convert images back to text and create PDFs
for i in "$temp_dir"/output-*.png; do
    echo "Cleaning page $i"
    ./textcleaner -g -e stretch -f 25 -o 10 -u -s 1 -T -p 10 "$i" "$temp_output_dir/$(basename "$i")"
done

# Step 3: Merge the OCR'd PDFs back into a single file
output_pdf="${input_pdf%.pdf}_optimized.pdf"
echo "Merging PDF pages..."
pdfunite "$temp_output_dir"/*.pdf "$output_pdf"

# Step 4: Optionally, compress the final PDF to reduce its file size
compressed_pdf="${input_pdf%.pdf}_compressed.pdf"
echo "Compressing PDF..."
gs -sDEVICE=pdfwrite -dCompatibilityLevel=1.4 -dPDFSETTINGS=/ebook -dNOPAUSE -dQUIET -dBATCH -sOutputFile="$compressed_pdf" "$output_pdf"

# Clean up
rm -r "$temp_dir"
rm -r "$temp_output_dir"

echo "Optimized PDF is at $output_pdf"
echo "Compressed PDF is at $compressed_pdf"
